---
keywords: fastai
description: "Explaining how to use Docker, Flask and Gunicorn to deploy your models online"
title: "How to make your models available to the public"
toc: true
branch: master
badges: true
comments: true
categories: [mlops, docker, computer-vision, ai]
image: images/docker-blog/mlops-loop-dockerblog2.jpg
hide: false
search_exclude: false
author: Suvaditya Mukherjee
hide_binder_badge: true
nb_path: _notebooks/2022-09-05-How-To-Make-Your-Models-Available-To-The-Public.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-09-05-How-To-Make-Your-Models-Available-To-The-Public.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">Introduction<a class="anchor-link" href="#Introduction"> </a></h2><p>An end-to-end Machine Learning solution is an important way to bring AI to production and make it available for mass consumption and usage. But today, most AI practitioners simply do the pre-processing, training, evaluation and tuning stages and leave the remaining part to DevOps engineers.</p>
<p>As such, a new field of development named <a href="https://blogs.nvidia.com/blog/2020/09/03/what-is-mlops/">MLOps</a> has come into the mainstream. The focus has shifted from simply training and evaluation to also bringing and integrating it to production pipelines.</p>
<p>On an individual level as well, knowing how to bring your model to the public is an important tool to have in an AI practitioner's skill-set.</p>
<p>In this article, we will be exploring how we can perform a small segment of the MLOps cycle in a simple and efficient manner using <strong>Keras</strong>, <strong>Flask</strong>, <strong>Gunicorn</strong> and <strong>Docker</strong>.</p>
<p>If you wish to skip through and go straight to the code, <a href="https://github.com/suvadityamuk/KerasDocker">click here to go to the GitHub repository</a></p>
<p><img src="/portfolio/images/copied_from_nb/../images/docker-blog/dockerblog1.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="What-is-covered-in-this-tutorial?">What is covered in this tutorial?<a class="anchor-link" href="#What-is-covered-in-this-tutorial?"> </a></h2><p>1) Create a custom model using <strong><code>Keras</code></strong> and its off-the-shelf components<br>
2) Prepare an inference pipeline<br>
3) Develop a simple <code>Flask</code> app to <strong>expose the model for inference</strong><br>
4) Define a <code>Dockerfile</code> using <code>Gunicorn</code><br>
5) <strong>Build our image</strong>
6) Define a simple <strong>Github Actions workflow</strong> to build your image every time you push it to your repository</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1)-Create-a-custom-model-using-Keras">1) Create a custom model using Keras<a class="anchor-link" href="#1)-Create-a-custom-model-using-Keras"> </a></h2><p>As an example, we are going to create a simple model using the Keras Functional API and an off-the-shelf MobileNetV2 model from <code>keras.applications</code> pretrained on ImageNet.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Import-headers">Import headers<a class="anchor-link" href="#Import-headers"> </a></h3><p>We require <code>tensorflow</code>, <code>keras</code>, <code>Flask</code>, <code>PIL</code> and <code>os</code> for this tutorial. If using a virtual environment, you can use the <code>requirements.txt</code> file below to get your env prepared.</p>
<ul>
<li><code>tensorflow</code>: Used for matrix operations and back-end for keras</li>
<li><code>keras</code>: Used for high-level Deep Learning model-building API and get pre-trained model</li>
<li><code>Flask</code>: Used for building simple API for inference</li>
<li><code>PIL</code>: Used for handling images</li>
<li><code>os</code>: Used for setting environment variables</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Set-options">Set options<a class="anchor-link" href="#Set-options"> </a></h3><p>Since GPUs are a difficult resource to get a hold of, we set a Tensorflow flag to make any CUDA devices present invisible in the first place. <em>If you can run your container on a GPU, feel free to skip this line.</em></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-1&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Model-definition">Model definition<a class="anchor-link" href="#Model-definition"> </a></h3><p>This model is made using the Keras Functional API. We take a simple <code>keras.Input</code> which accepts color (RGB) images of any size.<br>
The input is passed via the following layers:</p>
<ul>
<li><code>keras.layers.Resizing</code> : Used to resize the image tensor to a <strong>224x224x3</strong> tensor</li>
<li><code>keras.layers.Rescaling</code> : Used to rescale the image tensor values from a [0,255] range to a [0,1] range</li>
<li><code>keras.applications.MobileNetV2</code> : Used to import the <strong>MobileNetV2</strong> instance from Keras (pretrained on ImageNet)</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">image_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Resizing</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;lanczos3&#39;</span><span class="p">,</span> <span class="n">crop_to_aspect_ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">image_input</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Rescaling</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="n">mobilenet</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">(</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">include_top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span>
    <span class="n">input_tensor</span><span class="o">=</span><span class="n">image_input</span><span class="p">,</span>
    <span class="n">classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">classifier_activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span>
<span class="p">)</span>

<span class="n">model_output</span> <span class="o">=</span> <span class="n">mobilenet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">image_input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">model_output</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Requirements-file">Requirements file<a class="anchor-link" href="#Requirements-file"> </a></h3><p><code>Gunicorn</code> is used to deploy the API on several workers together to allow lower latency at the expense of increased compute consumption. Gunicorn is used since it implements WSGI. In a production environment, a front-facing server like <a href="https://www.nginx.com/"><strong>NGINX</strong></a> or <a href="https://httpd.apache.org/"><strong>Apache Web Server</strong></a> is used to host Static web pages and load balancers with Gunicorn running behind this layer to enable functionality.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Flask</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">3</span>
<span class="n">Pillow</span><span class="o">==</span><span class="mf">9.2</span><span class="o">.</span><span class="mi">0</span>
<span class="n">tensorflow</span><span class="o">==</span><span class="mf">2.9</span><span class="o">.</span><span class="mi">1</span>
<span class="n">gunicorn</span><span class="o">==</span><span class="mf">20.1</span><span class="o">.</span><span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2)-Prepare-an-inference-pipeline">2) Prepare an inference pipeline<a class="anchor-link" href="#2)-Prepare-an-inference-pipeline"> </a></h2><p>We define a simple function which accepts a <code>tf.Tensor</code> and runs it through the model to return a final top-5 predictions dictionary result.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Inference-function">Inference function<a class="anchor-link" href="#Inference-function"> </a></h3><p>The image, accepted as a <code>tf.Tensor</code>, is inferred using the function prepared before. The <code>numpy</code> value of the tensor is then extracted to get all the confidence scores for each class.<br>
This numpy array is then passed into <code>keras.applications.imagenet_utils.decode_predictions</code> to get the top 5 predictions.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">imagenet_utils</span><span class="o">.</span><span class="n">decode_predictions</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="3)-Make-a-simple-Flask-App-to-expose-model-for-inference">3) Make a simple Flask App to expose model for inference<a class="anchor-link" href="#3)-Make-a-simple-Flask-App-to-expose-model-for-inference"> </a></h2><p>Now, we define 2 simple endpoints at the routes <code>/</code> and <code>/inference</code>.</p>
<ul>
<li><code>/</code> (GET) : The first endpoint acts as a health-check to make sure that the API is up and running  </li>
<li><code>/inference</code> (POST) : The second endpoint accepts an image as a form field with the parameter name <code>image</code> and returns a dictionary with the confidence scores and the ImageNet class names</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Flask-App-definition">Flask App definition<a class="anchor-link" href="#Flask-App-definition"> </a></h3><p><code>app</code> is the name of the WSGI callable that will be used by Gunicorn later on. To know more about what WSGI is, check the Interesting Links section below.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Definition-of-health-check-endpoint">Definition of health-check endpoint<a class="anchor-link" href="#Definition-of-health-check-endpoint"> </a></h3><p>To test whether the API is up and running, we simply hit a GET request on this endpoint to get the expected output.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">health_check</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;outcome&#39;</span><span class="p">:</span><span class="s1">&#39;endpoint working successfully&#39;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Definition-of-inference-endpoint">Definition of inference endpoint<a class="anchor-link" href="#Definition-of-inference-endpoint"> </a></h3><p>Here, we accept a <code>POST</code> request, extract the <code>image</code> parameter from the files sent in the request. This is stored in a file-stream format which is then passed into a <code>PIL.Image.open</code> to prepare the image. Finally, we perform some simple pre-processing to convert the <code>PIL</code> image to a <code>tf.Tensor</code> and prepare a batch of 1 image to be passed into our inference function. The result returned is then passed into <code>jsonify</code> for response preparation and execution</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/inference&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">perform_inference</span><span class="p">():</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
    <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">inference</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>  
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="4)-Define-a-Dockerfile-which-uses-Gunicorn-for-deployment">4) Define a Dockerfile which uses Gunicorn for deployment<a class="anchor-link" href="#4)-Define-a-Dockerfile-which-uses-Gunicorn-for-deployment"> </a></h2><p>We are now done with defining our model and preparing it for inference using a simple Flask App. Here, we begin writing a <code>Dockerfile</code> and a <code>.dockerignore</code> to build a custom Docker Image</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">20.04</span>

<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> \
<span class="n">git</span> \
<span class="n">curl</span> \
<span class="n">ca</span><span class="o">-</span><span class="n">certificates</span> \
<span class="n">python3</span> \
<span class="n">python3</span><span class="o">-</span><span class="n">pip</span> \
<span class="n">sudo</span> \
<span class="o">&amp;&amp;</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span><span class="o">/*</span>

<span class="n">RUN</span> <span class="n">useradd</span> <span class="o">-</span><span class="n">m</span> <span class="n">docker_runner</span>

<span class="n">RUN</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">docker_runner</span><span class="p">:</span><span class="n">docker_runner</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">docker_runner</span>

<span class="n">COPY</span> <span class="o">--</span><span class="n">chown</span><span class="o">=</span><span class="n">docker_runner</span> <span class="o">*.*</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">docker_runner</span><span class="o">/</span><span class="n">flask_app</span><span class="o">/</span><span class="n">keras</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">trial</span><span class="o">/</span>

<span class="n">USER</span> <span class="n">docker_runner</span>

<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">docker_runner</span><span class="o">/</span><span class="n">flask_app</span><span class="o">/</span><span class="n">keras</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">trial</span>

<span class="n">ENV</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&quot;$</span><span class="si">{PATH}</span><span class="s2">:/home/docker_runner/.local/bin&quot;</span>

<span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="nb">dir</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>

<span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;gunicorn&quot;</span><span class="p">,</span> <span class="s2">&quot;--bind&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0:5000&quot;</span><span class="p">,</span> <span class="s2">&quot;--workers=4&quot;</span><span class="p">,</span> <span class="s2">&quot;app:app&quot;</span><span class="p">]</span>

<span class="n">EXPOSE</span> <span class="mi">5000</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Dockerfile">Dockerfile<a class="anchor-link" href="#Dockerfile"> </a></h3><ul>
<li>The first line pulls the <code>ubuntu:20.04</code> image from Docker Hub to prepare a container with stock Ubuntu 20.04 Focal Fossa within it.  </li>
<li>The first <code>RUN</code> command downloads and installs several essential packages that we require later ahead.</li>
<li>The next <code>RUN</code> command adds a user named docker_runner and creates a home directory for the user (using the -m option)</li>
<li>The next <code>RUN</code> command changes directory ownership and assigns docker_runner as the owner of its own home directory in a recursive manner for all files and subdirectories as well (using the -R option)</li>
<li>The <code>COPY</code> command moves all the files present in the current repository where the Dockerfile is into the container's target directory</li>
<li>The <code>USER</code> command is used to change the current active user to <code>docker_runner</code></li>
<li>The <code>WORKDIR</code> command is used to change the current active directory to <code>/home/docker_runner/flask_app/keras-docker-trial</code></li>
<li>The <code>ENV</code> command is used to set the PATH environment variable and add our user's <code>/.local/bin</code> directory to it</li>
<li>The <code>RUN</code> command is now used to install all the requirements and not use any cached directories or their SHA hashes while doing so</li>
<li>The <code>ENTRYPOINT</code> command is used to begin the API deployment using <code>gunicorn</code>. We bind the localhost's port 5000 and start up 4 workers for this task. We specify the WSGI callable as <code>app</code> on the left side of <code>app:app</code>. If you changed the name of the Flask app in Step 3, then you should change this part as <code>{your_app_name}:app</code></li>
<li>The <code>EXPOSE</code> command is used to make the container listen on port 5000</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id=".dockerignore">.dockerignore<a class="anchor-link" href="#.dockerignore"> </a></h3><p>We just ignore the <code>__pycache__/</code> directory as it generates intermediate files from CPython</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">__pycache__</span><span class="o">/</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="5)-Build-our-image-and-deploy-it-to-Docker-Hub">5) Build our image and deploy it to Docker Hub<a class="anchor-link" href="#5)-Build-our-image-and-deploy-it-to-Docker-Hub"> </a></h2><p>We now build our image and assign it a tag <code>keras-docker-trial</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">.</span> <span class="o">-</span><span class="n">t</span> <span class="n">keras</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">trial</span> <span class="o">--</span><span class="n">file</span> <span class="n">Dockerfile</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="6)-Define-a-simple-GitHub-Actions-workflow-to-build-your-image-every-time-you-push-it-to-your-repository">6) Define a simple GitHub Actions workflow to build your image every time you push it to your repository<a class="anchor-link" href="#6)-Define-a-simple-GitHub-Actions-workflow-to-build-your-image-every-time-you-push-it-to-your-repository"> </a></h2><p>Here, as an extra step, we use GitHub Actions to build our image as a test every time a Push is made to any branch or if a PR is merged in the repository. This needs to be added only if you are preparing a repository on GitHub for your model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="n">Docker</span> <span class="n">CI</span>

<span class="n">on</span><span class="p">:</span>
  <span class="n">push</span><span class="p">:</span>
  <span class="n">pull_request</span><span class="p">:</span>
    <span class="n">types</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;opened&#39;</span><span class="p">,</span> <span class="s1">&#39;reopened&#39;</span><span class="p">]</span>

<span class="n">env</span><span class="p">:</span>
  <span class="n">BUILD_CONFIGURATION</span><span class="p">:</span> <span class="n">Release</span>

<span class="n">jobs</span><span class="p">:</span>
  <span class="n">job1</span><span class="p">:</span>
    <span class="n">runs</span><span class="o">-</span><span class="n">on</span><span class="p">:</span> <span class="n">ubuntu</span><span class="o">-</span><span class="n">latest</span>
    <span class="n">steps</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Check</span><span class="o">-</span><span class="n">out</span> <span class="n">the</span> <span class="n">pushed</span> <span class="n">code</span>
        <span class="n">uses</span><span class="p">:</span> <span class="n">actions</span><span class="o">/</span><span class="n">checkout</span><span class="nd">@v3</span>

      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Build</span> <span class="n">Docker</span> <span class="n">image</span>
        <span class="n">run</span><span class="p">:</span> <span class="n">docker</span> <span class="n">build</span> <span class="o">.</span> <span class="o">-</span><span class="n">t</span> <span class="n">keras</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">trial</span> <span class="o">--</span><span class="n">file</span> <span class="n">Dockerfile</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Test-the-pipeline">Test the pipeline<a class="anchor-link" href="#Test-the-pipeline"> </a></h2><p>Above, we have defined the model and deployed it using Docker and Gunicorn. You can find some example screenshots of the deployment and its predictions via Postman API Explorer below.</p>
<p><img src="/portfolio/images/copied_from_nb/../images/docker-blog/terminal.png" alt=""></p>
<p align="center">Terminal command</p><p><img src="/portfolio/images/copied_from_nb/../images/docker-blog/health-check.png" alt=""></p>
<p align="center">GET request on health-check</p><p><img src="/portfolio/images/copied_from_nb/../images/docker-blog/inference.png" alt=""></p>
<p align="center">GET request on inference</p><p><img src="/portfolio/images/copied_from_nb/../images/docker-blog/goldfish.jpg" alt=""></p>
<p align="center">The Goldfish image sent for request via Postman </p><!-- 
| ![](../images/docker-blog/terminal.png) | 
|:--:| 
| **Terminal command** |  

| ![](../images/docker-blog/health-check.png) | 
|:--:| 
| **GET request on health-check** |  

| ![](../images/docker-blog/inference.png) | 
|:--:| 
| **GET request on inference** |  

| ![](../images/docker-blog/goldfish.jpg) | 
|:--:| 
| **The Goldfish image sent for request via Postman** |   -->
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion"> </a></h2><p>Above, we have completed the development of a simple Keras model, its deployment via Docker and a GitHub Actions workflow for CI(Continuous Integration).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Future-Scope">Future Scope<a class="anchor-link" href="#Future-Scope"> </a></h2><p>This is only a small part of what can be done as a part of a simple MLOps pipeline. CML (Continuous Machine Learning) and DVC (Data Version Control) are two important concepts that are an integral part of every self-sustaining machine learning workflow and can be explored further. Resources to do so are present in the Interesting Links section.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="References">References<a class="anchor-link" href="#References"> </a></h2><p>1.) <a href="https://docs.docker.com/docker-hub/">Docker Hub Documentation</a><br>
2.) <a href="https://keras.io/api/applications/mobilenet/#mobilenetv2-function">Keras Applications Documentation</a><br>
3.) <a href="https://docs.gunicorn.org/en/stable/configure.html">Gunicorn Documentation</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Interesting-Links">Interesting Links<a class="anchor-link" href="#Interesting-Links"> </a></h2><p>1.) <a href="https://cml.dev/">What is CML?</a><br>
2.) <a href="https://dvc.org/doc/user-guide/what-is-dvc">What is DVC?</a><br>
3.) <a href="https://wsgi.readthedocs.io/en/latest/what.html">What is WSGI (Web Server Gateway Interface)?</a><br>
4.) <a href="https://neptune.ai/blog/mlops">Detailed blog on What is MLOps?</a></p>

</div>
</div>
</div>
</div>
 

